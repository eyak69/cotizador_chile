# Aprendizajes del Proyecto

- **Persistencia de Datos**: Siempre se debe agregar datos por medio de herramientas (scripts como `seed_prompts.js` o migraciones) para que quede documentado y se pueda recuperar en caso de reinicio de la base de datos.
- **Diferencias Visuales en Docker**: Las fuentes "system-ui" var铆an dr谩sticamente entre Windows y Linux (Docker). Para consistencia visual, siempre define fuentes web expl铆citas (e.g., 'Outfit', 'Roboto') en el CSS global (`:root` o `body`), evitando depender de las fuentes del sistema operativo.
- **Docker en Monorepos**: Es CRTICO usar `**/node_modules` en `.dockerignore`. Si usas solo `node_modules`, las carpetas anidadas (ej: `frontend/node_modules`) se copiar谩n al contenedor, llevando binarios de Windows a Linux y rompiendo el build silenciosamente.
- **Conflictos Legacy vs SPA**: Al migrar o coexistir con aplicaciones antiguas en Express, NUNCA uses `app.use(express.static('public'))` globalmente si esa carpeta contiene un `index.html` viejo. Express servir谩 ese archivo antes que tu aplicaci贸n React, ocult谩ndola por completo.
- **Manejo de Valores Falsy (0 vs null)**: En JavaScript, el n煤mero `0` se eval煤a como falso. Al usar el operador OR (`||`) para asignar valores por defecto (ej: `val || default`), el `0` ser谩 reemplazado por el default, lo cual es incorrecto si `0` es un valor v谩lido. Para evitar esto, utiliza Nullish Coalescing (`??`) en el frontend y validaciones expl铆citas de `undefined` en el backend.
- **Inicializaci贸n Expl铆cita de Servicios**: Importar un m贸dulo de conexi贸n a base de datos (e.g., `{ connectDB } = require('./database')`) NO ejecuta la conexi贸n autom谩ticamente. Siempre verifica que la funci贸n de inicializaci贸n se INVOQUE expl铆citamente al arranque del servidor (e.g., `connectDB()`).
- **Robustez ante Filtros de Seguridad IA**: Al usar APIs generativas como Gemini, no asumas que siempre devolver谩n texto. Los filtros de seguridad ("Safety Filters") pueden bloquear la respuesta, resultando en `candidates` vac铆os. Siempre verifica `response.candidates` antes de intentar extraer texto para evitar excepciones no controladas.
- **Limpieza de Temporales**: Siempre eliminar archivos temporales (como versiones optimizadas de PDFs o im谩genes recortadas) inmediatamente despu茅s de su uso para evitar el consumo innecesario de espacio en disco en entornos de producci贸n.
- **Generaci贸n de Word**: `Docxtemplater` + `PizZip` es superior a `docx-templates` por claridad de sintaxis (`{tag}`, `{#loop}`) y robustez en bucles complejos. Es fundamental validar que el archivo `.docx` de plantilla no tenga etiquetas XMl rotas internamente.
- **Refactorizaci贸n Monolito a Modular**: Separar la l贸gica en Servicios (`Service Layer`) y dejar los Controladores ligeros facilita el mantenimiento y la reutilizaci贸n. Mover scripts sueltos a `scripts/utils/` mantiene la ra铆z limpia y organizada.
- **UI Tablas Jer谩rquicas**: El patr贸n "Master-Detail" con filas colapsables en React/MUI evita la sobrecarga visual y permite acceder a detalles sin navegar a otra p谩gina o descargar archivos. La paginaci贸n y el ordenamiento descendente (m谩s reciente primero) son claves para la usabilidad.
- **Frontend API Layer**: Centralizar las llamadas a axios en un archivo `services/api.js` act煤a como un SDK interno. Esto evita hardcodear URLs en componentes, permite interceptores globales de error y facilita el refactoring futuro.
- **Backend Robustez**: Implementar un `Global Error Handler` como middleware asegura que ninguna excepci贸n no controlada "cuelgue" el servidor, devolviendo siempre respuestas JSON estructuradas incluso ante fallos cr铆ticos.
- **AdminService**: Centralizar la l贸gica de negocio administrativa (ABMs simples) en un servicio dedicado evita la dispersi贸n de c贸digo en controladores y facilita la validaci贸n centralizada.
- **Scripts NPM y Rutas**: Cuando defines un script en `package.json` (ej: `"init": "node scripts/utils/seed.js"`), el proceso de Node corre desde la ra铆z del proyecto. Sin embargo, los archivos ejecutados deben manejar sus imports asumiendo su propia ubicaci贸n f铆sica o usando rutas absolutas/alias. Si un script en `scripts/utils/` hace `require('./model')`, buscar谩 en `scripts/utils/model`, lo cual suele ser incorrecto si los modelos est谩n en la ra铆z. Usa `../../` o rutas absolutas.
- **Docker Bind Mounts vs Im谩genes**: Los vol煤menes tipo "bind" (`./local:/container`) ocultan completamente el contenido original del directorio en el contenedor. Para preservar subcarpetas incluidas en la imagen (como `templates`), nunca montes el directorio padre completo; monta solo las subcarpetas espec铆ficas que requieren persistencia (`./local/temp:/container/temp`).
- **Error EXDEV en Docker**: Mover archivos (`fs.rename`) entre un volumen Docker y una carpeta del sistema de archivos del contenedor falla porque se consideran dispositivos diferentes. La soluci贸n robusta es copiar el archivo (`fs.copyFile`) y luego eliminar el original (`fs.unlink`), en lugar de moverlo.
- **Collation en MySQL Docker**: Las im谩genes oficiales de MySQL suelen usar `latin1` por defecto. Si tu entorno local usa `utf8mb4` (est谩ndar moderno), ver谩s errores de codificaci贸n o diferencias con emojis. Fuerza UTF-8 en `docker-compose.yml` con `command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci`.
- **Despliegue en Mac/Linux**: Los scripts `.sh` descargados desde repositorios en Windows a menudo pierden o no tienen permisos de ejecuci贸n. Siempre instruye al usuario a ejecutar `chmod +x script.sh` antes de usarlo. Adem谩s, Docker en Macs con Apple Silicon soporta im谩genes `linux/amd64` transparentemente gracias a Rosetta 2.
- **Navegaci贸n en React/MUI**: Para aplicaciones complejas, migrar de `Tabs` a un `Drawer` (Sidebar) permanente mejora significativamente la escalabilidad y experiencia de usuario. Requiere un layout `Flex` donde el sidebar es fijo y el contenido principal tiene `flexGrow: 1` para ocupar el espacio restante din谩micamente.
- **Rastreo de Fuente en Documentos IA**: Al procesar documentos completos (multi-p谩gina) con LLMs, es fundamental solicitar expl铆citamente en el prompt la p谩gina de origen (`paginas_encontradas`) y, en el caso de texto plano (OpenAI), inyectar marcadores de p谩gina (`---[[PGINA X]]---`) durante la extracci贸n del PDF para que el modelo pueda referenciar correctamente la ubicaci贸n de la informaci贸n.
- **Versionado Autom谩tico**: Antes de cada commit, SIEMPRE el asitente debe incrementar el n煤mero de versi贸n (patch) en `package.json` AUTOMATICAMENTE para que el cliente sepa si su despliegue se actualiz贸.
- **Actualizaci贸n Cliente Docker**: Al usar `sequelize.sync({ alter: true })`, los cambios de esquema (nuevas columnas) se propagan autom谩ticamente al contenedor del cliente tras un `docker-compose pull`, sin p茅rdida de datos, facilitando el despliegue continuo.
- **Configuraci贸n Vite/PostCSS en Windows**: Si `vite` falla con `[plugin:vite:css] Failed to load PostCSS config ... Unexpected token '', "{ "name"...`, es probable que `package.json` tenga un BOM (Byte Order Mark) invisible o codificaci贸n incorrecta, ya que Vite intenta leerlo al buscar configuraci贸n de PostCSS. La soluci贸n es recrear el archivo con codificaci贸n UTF-8 pura o a帽adir un `postcss.config.js` expl铆cito.
- **Formato de Fechas y Localizacin (i18n)**: Al generar documentos (Word/PDF) en el servidor, 
ew Date().toLocaleDateString() sin argumentos usa la configuracin regional del sistema operativo host (ej: en-US en Mac da mm/dd/yyyy). Para garantizar consistencia (ej: dd/mm/yyyy) independientemente del entorno (Docker, Windows, Mac), SIEMPRE especifica la localidad (es-CL) y las opciones ({ day: '2-digit'... }). Adems, para evitar ambigedades entre guiones y barras, fuerza el reemplazo .replace(/-/g, '/') si el formato de negocio lo requiere.
